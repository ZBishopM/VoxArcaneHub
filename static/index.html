<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxArcane Hub | AI Transcription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            background: radial-gradient(circle at top left, #1e1e2e, #11111b);
            color: #cdd6f4;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .hypr-card {
            background: rgba(49, 50, 68, 0.3);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(205, 214, 244, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        .glow-border:hover {
            border: 1px solid #cba6f7;
            box-shadow: 0 0 15px rgba(203, 166, 247, 0.3);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="status-bar" class="hypr-card px-4 py-2 mb-8 flex items-center gap-4 text-sm opacity-0">
        <span class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            GPU powered
        </span>
        <span id="vram-info" class="text-slate-400">Cargando hardware...</span>
    </div>

    <main class="hypr-card p-8 w-full max-auto max-w-2xl opacity-0" id="main-container">
        <h1 class="text-4xl font-extrabold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
            VoxArcane Hub
        </h1>
        <p class="text-slate-400 mb-8 italic">IA-Powered Transcription for Voice Actors</p>

        <div class="border-2 border-dashed border-slate-600 rounded-xl p-10 text-center glow-border cursor-pointer transition-all" id="dropzone">
            <input type="file" id="fileInput" class="hidden" accept="audio/*">
            <div id="upload-text">
                <p class="text-lg">Suelta tu audio aquí o <span class="text-purple-400 font-bold">explora</span></p>
                <p class="text-sm text-slate-500 mt-2">WAV, MP3, M4A (Max 25MB)</p>
            </div>
            <div id="loading" class="hidden flex-col items-center">
                <div class="w-10 h-10 border-4 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-purple-400 font-medium">Transcribiendo audio...</p>
            </div>
        </div>

        <div id="result-area" class="mt-8 hidden">
            <h3 class="text-sm uppercase tracking-widest text-slate-500 mb-2">Transcripción</h3>
            <div class="bg-[#181825] p-4 rounded-lg border border-slate-700 max-h-60 overflow-y-auto">
                <p id="transcription-text" class="leading-relaxed text-slate-200"></p>
            </div>
        </div>

        <div id="history-section" class="mt-10 w-full hidden opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-200">Historial de Procesamiento</h2>
                <span class="text-xs bg-purple-900 text-purple-200 px-2 py-1 rounded border border-purple-500/30">Actualizado</span>
            </div>

            <div class="overflow-hidden rounded-lg border border-slate-700 bg-[#1e1e2e]/50 backdrop-blur-sm">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-black/20 text-xs uppercase font-medium text-purple-400">
                        <tr>
                            <th class="px-4 py-3">ID</th>
                            <th class="px-4 py-3">Archivo</th>
                            <th class="px-4 py-3">Tiempo (GPU)</th>
                            <th class="px-4 py-3">Idioma</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="divide-y divide-slate-700/50">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Animacion de entrada
        window.onload = () => {
            gsap.to("#status-bar", { opacity: 1, y: 10, duration: 1, ease: "power4.out" });
            gsap.to("#main-container", { opacity: 1, y: 0, duration: 1.2, delay: 0.3, ease: "power4.out" });
            actualizarHardware();
            cargarHistorial();
        };

        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');

        dropzone.onclick = () => fileInput.click();

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // UI Feedback
            document.getElementById('upload-text').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload-audio', { method: 'POST', body: formData });
                const data = await response.json();
                
                // Mostrar resultado
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('transcription-text').innerText = data.transcripcion.texto;
                
                cargarHistorial();

                // Animación de aparición del texto
                gsap.from("#result-area", { opacity: 0, y: 20, duration: 0.5 });
            } catch (error) {
                alert("Error al procesar el audio");
            } finally {
                document.getElementById('upload-text').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
            }
        };

        async function actualizarHardware() {
            const res = await fetch('/status');
            const data = await res.json();
            document.getElementById('vram-info').innerText = `${data.modelo} | VRAM Libre: ${data.vram_libre}`;
        }

        async function cargarHistorial() {
            try {
                const res = await fetch('/historial');
                const grabaciones = await res.json();

                const lista = document.getElementById('history-list');
                lista.innerHTML = ''; // Limpiar lista actual
            
                if (grabaciones.length > 0) {
                    document.getElementById('history-section').classList.remove('hidden');

                    // Animación de entrada para la sección
                    gsap.to("#history-section", { opacity: 1, duration: 0.5 });
                }
            
                grabaciones.forEach((g, index) => {
                    const row = `
                        <tr class="hover:bg-white/5 transition-colors cursor-default group">
                            <td class="px-4 py-3 font-mono text-slate-500">#${g.id}</td>
                            <td class="px-4 py-3 font-medium text-white group-hover:text-purple-300 transition-colors">${g.filename}</td>
                            <td class="px-4 py-3 text-green-400 font-mono">${g.duracion_proceso || 'N/A'}</td>
                            <td class="px-4 py-3 uppercase text-xs tracking-wider">${g.idioma}</td>
                        </tr>
                    `;
                    lista.innerHTML += row;
                });
            
                // Animación "stagger" (efecto cascada tipo Hyprland) para las filas
                gsap.from("#history-list tr", { 
                    opacity: 0, 
                    x: -20, 
                    duration: 0.4, 
                    stagger: 0.1 
                });
            
            } catch (error) {
                console.error("Error cargando historial:", error);
            }
        }        
    </script>
</body>
</html>